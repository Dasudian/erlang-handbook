\chapter{Распределённый Erlang}
\label{distribution}

\textbf{Распределённая Erlang-система} состоит из некоторого количества систем 
времени исполнения Erlang, которые сообщаются друг с другом.  Каждая такая система
называется \textbf{узлом} (node). Узлы могут находиться на одной физической машине
или на разных и быть соединёнными посредством сети.  Стандартный механизм 
распределения реализован на основе TCP/IP сокетов, но могут быть реализованы и 
другие механизмы.

Передача сообщений между процессами на разных узлах, так же как и связи между
процессами и мониторы, прозрачно реализована используя идентификаторы процессов 
(pid).  Однако, зарегистрированные имена локальны для каждого из узлов.  
На зарегистрированный процесс на конкретном узле можно ссылаться с помощью кортежа
\texttt{\{Имя,Узел\}}.

Служба отображения портов Erlang (Erlang Port Mapper Daemon, или \textbf{epmd}) 
автоматически стартует на каждом компьютере, где имеется запущенный узел Erlang.
Он отвечает за отображение имён узлов в сетевые адреса компьютеров.


\section{Узлы}

\textbf{Узел} --- это исполняемая в данный момент Erlang-система, которой было 
назначено имя, используя параметр командной строки \texttt{-name} (длинное имя)
или \texttt{-sname} (короткое имя).

Формат имени узла --- атом вида \texttt{Имя@Адрес}, где \texttt{Имя} задаётся 
пользователем, запустившим изул, а \texttt{Адрес} --- полное имя сервера, если
были включены длинные имена, или первая часть имени сервера (если были 
использованы короткие имена). Функция \texttt{node()} возвращает имя узла.  Узлы,
использующие длинные имена не могут связываться с узлами, использующими короткие
имена.


\section{Соединение между узлами}

Узлы распределённой Erlang-системы полностью соединены (каждый с каждым). Первый
раз, когда используется новое имя узла, производится попытка подключения к этому
узлу. Если узел \texttt{A} подключается к узлу \texttt{B}, и узел \texttt{B} 
имел открытое подключение к узлу \texttt{C}, то узел \texttt{А} тоже попытается
подключиться к узлу \texttt{C}.  Эта возможность может быть отключена используя
параметр командной строки:

\qquad\texttt{-connect\_all false}

Если узел прекращает работу или теряет сеть, все подключения к нему удаляются.
Встроенная функция:

\begin{erlangru}
erlang:disconnect(Узел)
\end{erlangru}

отключает заданный \texttt{Узел}. Встроенная функция \texttt{nodes()} вернёт 
список подключенных в данный момент (видимых) узлов.


\section{Скрытые узлы}

Иногда полезно подключиться к нужному узлу, не инициируя веер подключений ко всем
остальным узлам.  Для этой цели можно использовать \textbf{скрытый узел}. 
Скрытый узел это узел, запущенный с параметром командной строки \texttt{-hidden}. 
Подключения между скрытыми узлами и другими узлами должны устанавливаться вручную 
и явно.  Скрытые узлы не видны в списке узлов, возвращаемом функцией 
\texttt{nodes()}.  Вместо этого следует использовать \texttt{nodes(hidden)} или 
\texttt{nodes(connected)}.  Скрытый узел не будет включён в набор узлов, за 
которыми следит модуль \texttt{global}.

\textbf{Узел на языке С} это С-программа, написанная, чтобы действовать и 
выглядеть, как скрытый узел в распределённой Erlang-системе.  Библиотека 
\texttt{erl\_interface} содержит необходимые для этого функции.


\section{Секретный куки (cookie)}

Каждый узел имеет свой собственный \textbf{магический куки} (cookie), который 
является атомом. Сервер сетевой аутентикации Erlang (под названием \texttt{auth})
читает содержимое куки из файла \texttt{\$HOME/.erlang.cookie}.  Если файл не
существовал, он будет создан и в него будет записана случайная строка.

% FRMB CHECK: the implication here is that "erlang:set_cookie(node(), Cookie)"
% sets *this* node's cookie, as well as the cookie that will be used to connect
% to other nodes, if not explicitly set otherwise.

Права доступа к файлу должны быть установлены в восьмеричное 0400 (только для
чтения владельцем).  Куки локального узла также можно установить с помощью 
встроенной функции \texttt{erlang:set\_cookie(node(), Куки)}.

Текущему узлу позволяется подключаться к другому узлу \texttt{Узел2}, если он
знает значение его куки.  Если оно отличается от куки текущего узла (чей куки 
будет использован по умолчанию), то его надо явно установить с помощью встроенной 
функции \texttt{erlang:set\_cookie(Узел2, Куки2)}.


\section{Встроенные функции для распределения}

\begin{center}
\begin{tabular}{|>{\raggedright}p{150pt}|>{\raggedright}p{280pt}|}
\hline
\multicolumn{2}{|p{326pt}|}{Встроенные функции для распределения}\tabularnewline
\hline
\texttt{node()}  & 
Возвращает имя текущего узла. Позволяется использовать в охранных выражениях
\tabularnewline
\hline
\texttt{is\_alive()}  & 
Возвращает \texttt{true} если система является узлом и может подключаться к другим 
узлам, иначе \texttt{false} \tabularnewline
\hline
\texttt{erlang:get\_cookie()}  & 
Возвращает магический куки текущего узла \tabularnewline
\hline
\texttt{set\_cookie(\\
	\qquad{}Узел, Куки)} & 
Устанавливает магический \texttt{Куки}, который будет использован при подключении 
к \texttt{Узлу}. Если \texttt{Узел} --- текущий узел, то \texttt{Куки} будет 
использован для всех подключений к новым узлам \tabularnewline
\hline
\texttt{nodes()}  & 
Возвращает список всех видимых узлов, к которым подключен текущий \tabularnewline
\hline
\texttt{nodes(connected)\\
	nodes(hidden)}  & 
Возвращает список не только видимых, но и скрытых и ранее известных узлов, и т.д. 
\tabularnewline
\hline
\texttt{monitor\_node(Узел,}\\
\texttt{\qquad{}true\textbar{}false)}  & 
Отслеживает статус \texttt{Узла}. Сообщение \texttt{\{nodedown, Узел\}} будет
прислано процессу, если подключение к узлу потеряно \tabularnewline
\hline
\texttt{node(Pid\textbar{}Ref\textbar{}Port)}  & 
Возвращает имя узла, на котором зарегистрирован аргумент \tabularnewline
\hline
\texttt{erlang:disconnect\_node\\
	\qquad(Узел)}  & 
Принудительно отключает \texttt{Узел} от кластера \tabularnewline
\hline
\texttt{spawn[\_link\textbar{}\_opt](}\\
\texttt{Узел, Модуль, Функция, 
	Аргументы)}  & Создаёт процесс на другом (удалённом) узле \tabularnewline
\hline
\texttt{spawn[\_link\textbar{}\_opt](\\
	Узел, Функция)}  & 
Создаёт процесс на удалённом узле \tabularnewline
\hline
\end{tabular}
\end{center}


\section{Параметры командной строки}

\begin{center}
\begin{tabular}{|>{\raggedright}p{120pt}|>{\raggedright}p{310pt}|}
\hline
\multicolumn{2}{|p{430pt}|}{Параметры командной строки для распределённого  
	Erlang}\tabularnewline
\hline
\texttt{-connect\_all false}  & 
Подключение новых узлов только вручную и явно перечисляется каждый узел 
\tabularnewline
\hline
\texttt{-hidden}  & 
Стартует узел как скрытый \tabularnewline
\hline
\texttt{-name Имя}  & 
Превращает систему Erlang в узел кластера, используя длинные имена узлов 
\tabularnewline
\hline
\texttt{-setcookie Куки}  & Аналогично вызову \linebreak{}
\texttt{erlang:set\_cookie(node(), Куки))}\tabularnewline
\hline
\texttt{-sname Имя}  & 
Превращает систему Erlang в узел кластера, используя короткие имена узлов 
\tabularnewline
\hline
\end{tabular}
\end{center}


\section{Модули с поддержкой распределённых систем}

Есть несколько доступных модулей, которые пригодятся при программировании 
распределённых систем:

\begin{center}
\begin{tabular}{|>{\raggedright}p{93pt}|>{\raggedright}p{233pt}|}
\hline
\multicolumn{2}{|p{326pt}|}{Модули с поддержкой распределённых 
	систем}\tabularnewline
\hline
\texttt{global}  & 
Глобальное средство регистрации имён \tabularnewline
\hline
\texttt{global\_group}  & 
Соединение узлов в глобальные группы регистрации имён \tabularnewline
\hline
\texttt{net\_adm}  & 
Различные функции для управления сетью в Erlang-системе \tabularnewline
\hline
\texttt{net\_kernel}  & 
Ядро работы с сетью \tabularnewline
\hline
\multicolumn{2}{|p{326pt}|}{Модули стандартной библиотеки, полезные для 
	разработки распределённых систем}\tabularnewline
\hline
\texttt{slave}  & Запуск и управление ведомыми узлами \tabularnewline
\hline
\end{tabular}
\end{center}
